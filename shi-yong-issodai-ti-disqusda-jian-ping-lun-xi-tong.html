<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>使用isso代替disqus搭建评论系统 — 陈晓伟的个人博客</title>
	<meta name="description" content="Title: 使用isso代替disqus搭建评论系统; Date: 2017-10-20; Author: NegativeDearc">
	<meta name="author" content="NegativeDearc">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
		<script src="https://negativedearc.github.io/theme/html5.js"></script>
		<![endif]-->
	<link href="https://negativedearc.github.io/theme/css/ipython.css" rel="stylesheet">
	<!-- <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet"> -->
	<!-- <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"> -->
	<!-- <link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/simplex/bootstrap.min.css" rel="stylesheet"> -->
	<link href="https://negativedearc.github.io/theme/css/bootstrap.min.css" rel="stylesheet">
	<link href="https://negativedearc.github.io/theme/css/font-awesome.min.css" rel="stylesheet">
	<link href="https://negativedearc.github.io/theme/css/bootswatch.min.css" rel="stylesheet">
	<link href="https://negativedearc.github.io/theme/css/local.css" rel="stylesheet">
	<link href="https://negativedearc.github.io/theme/css/pygments.css" rel="stylesheet">
</head>
<body>
<div class="container">
	<div class="page-header">
		<h1><a href="https://negativedearc.github.io/">陈晓伟的个人博客</a>
			<br>
<small>Hello, I'm a Continues Improvement Engineer</small>
		</h1>
	</div>
	<div class="row">
		<div class="col-md-8 col-md-offset-2">
<div class="article" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="text-center article-header">
		<h1 itemprop="name headline" class="article-title">使用isso代替disqus搭建评论系统</h1>
		<span itemprop="author" itemscope itemtype="http://schema.org/Person">
			<h4 itemprop="name">NegativeDearc</h4>
		</span>
		<time datetime="2017-10-20T22:16:00+08:00" itemprop="datePublished">Fri 20 October 2017</time>
	</div>
	<div>
		Category:
		<span itemprop="articleSection">
			<a href="https://negativedearc.github.io/category/bian-cheng.html" rel="category">编程</a>
		</span>
	</div>
 
	<div>
		Tags:
		<span itemprop="keywords">
			<a href="https://negativedearc.github.io/tag/python.html" rel="tag">Python</a>
		</span>
	</div>
	<div itemprop="articleBody" class="article-body"><h3>前言</h3>
<p>一直想搭建一个self-hosted的评论系统，心里种草很久。多说的倒闭、Disqus在国内无法访问，加上技术储备并不充分，虽然尝试写了一个非常简单评论功能，见<a href="http://www.kukumalu.cc/li-yong-jinjahong-ji-sqlite-cteshe-ji-lei-si-wang-yi-ping-lun-de-hui-fu-xi-tong.html">文章</a>，和预期相差甚远。</p>
<p>一方面在互联网搜索各式的开源评论系统设计，</p>
<ul>
<li>说吧，基于Node.js和MongoDB&nbsp;<a href="https://github.com/yuyouwen/shuoba">yuyouwen/shuoba</a></li>
<li>Gitment，基于Github Issue&nbsp;<a href="https://github.com/imsun/gitment">imsun/gitment</a></li>
<li>Isso，基于python和SQLite，Disqus的替代品&nbsp;<a href="https://github.com/posativ/isso">posativ/isso</a></li>
</ul>
<p>一方面也终于抽出时间尝试。这篇文章记录了基于Python的isso的搭建过程和一些“坑”及解决方案。</p>
<h3>准备工作</h3>
<p>Isso强烈建议评论系统不应直接暴露在公网环境，同时以作为sub URI作为评论访问地址，能够避免一些强隐私保护浏览器屏蔽评论。但会带来跨域资源共享问题(<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a>)。</p>
<h4>二级域名解析</h4>
<p>以本博客<a href="http://www.kukumalu.cc">kukumalu.cc</a>为例, 申请了<a href="comment.kukumalu.cc">comment.kukumalu.cc</a>作为二级域名，在阿里云设置了A纪录解析到服务器。</p>
<ul>
<li>解析到自己网站，<a href="https://help.aliyun.com/knowledge_detail/39785.html">说明</a></li>
<li>解析到其他网站，<a href="">??</a></li>
</ul>
<h4>配置准备</h4>
<p><strong><em>isso.cfg</em></strong></p>
<div class="highlight"><pre><span></span><span class="k">[general]</span>
<span class="c1"># 数据库所在路径</span>
<span class="na">dbpath</span> <span class="o">=</span> <span class="s">/var/lib/isso/comments.db</span>

<span class="c1"># 你的主机域名，注意不是评论系统所在域名, Isso会自动处理CORS</span>
<span class="na">host</span> <span class="o">=</span> <span class="s">http://www.kukumalu.cc</span>

<span class="c1"># 允许用户移除、编辑评论的最大时间</span>
<span class="na">max-age</span> <span class="o">=</span> <span class="s">15m</span>

<span class="c1"># 获得评论相关通知的方式</span>
<span class="c1"># stdout</span>
<span class="c1">#     Log to standard output. Default, if none selected.</span>
<span class="c1"># smtp</span>
<span class="c1">#     Send notifications via SMTP on new comments with activation (if</span>
<span class="c1">#     moderated) and deletion links.</span>
<span class="na">notify</span> <span class="o">=</span> <span class="s">stdout</span>

<span class="c1"># 日志文件存放路径</span>
<span class="na">log-file</span> <span class="o">=</span> <span class="s">/var/log/isso/isso.log</span>

<span class="c1">#################################</span>
<span class="c1">#后面配置保持默认，可运行，按需修改#</span>
<span class="c1">#################################</span>

<span class="k">[moderation]</span>
<span class="c1"># 评论审核相关配置</span>
<span class="c1"># Comments in modertion queue are not visible to other users until you activate</span>
<span class="c1"># them.</span>
<span class="na">enabled</span> <span class="o">=</span> <span class="s">false</span>

<span class="c1"># remove unprocessed comments in moderation queue after given time.</span>
<span class="na">purge-after</span> <span class="o">=</span> <span class="s">30d</span>


<span class="k">[server]</span>
<span class="c1"># 服务端相关配置</span>
<span class="c1"># interface to listen on. Isso supports TCP/IP and unix domain sockets: UNIX</span>
<span class="c1"># domain socket listen = unix:///tmp/isso.sock TCP/IP listen =</span>
<span class="c1"># http:///localhost:1234/</span>
<span class="c1">#</span>
<span class="c1"># When gevent is available, it is automatically used for http:// Currently,</span>
<span class="c1"># gevent can not handle http requests on unix domain socket (see #295 and #299</span>
<span class="c1"># for details).  Does not apply for uWSGI.</span>
<span class="na">listen</span> <span class="o">=</span> <span class="s">http://localhost:8080</span>

<span class="c1"># reload application, when the source code has changed. Useful for development.</span>
<span class="c1"># Only works with the internal webserver.</span>
<span class="na">reload</span> <span class="o">=</span> <span class="s">off</span>

<span class="c1"># show 10 most time consuming function in Isso after each request. Do not use</span>
<span class="c1"># in production.</span>
<span class="na">profile</span> <span class="o">=</span> <span class="s">off</span>


<span class="k">[smtp]</span>
<span class="c1"># 邮件通知相关配置</span>
<span class="c1"># Isso can notify you on new comments via SMTP. In the email notification, you</span>
<span class="c1"># also can moderate (=activate or delete) comments.</span>

<span class="c1"># self-explanatory, optional</span>
<span class="na">username</span> <span class="o">=</span>

<span class="c1"># self-explanatory (yes, plain text, create a dedicated account for</span>
<span class="c1"># notifications), optional.</span>
<span class="na">password</span> <span class="o">=</span>

<span class="c1"># SMTP server</span>
<span class="na">host</span> <span class="o">=</span> <span class="s">localhost</span>

<span class="c1"># SMTP port</span>
<span class="na">port</span> <span class="o">=</span> <span class="s">587</span>

<span class="c1"># use a secure connection to the server, possible values: none, starttls or</span>
<span class="c1"># ssl. Note, that there is no easy way for Python 2.7 and 3.3 to implement</span>
<span class="c1"># certification validation and thus the connection is vulnerable to</span>
<span class="c1"># Man-in-the-Middle attacks. You should definitely use a dedicated SMTP account</span>
<span class="c1"># for Isso in that case.</span>
<span class="na">security</span> <span class="o">=</span> <span class="s">starttls</span>

<span class="c1"># recipient address, e.g. your email address</span>
<span class="na">to</span> <span class="o">=</span>

<span class="c1"># sender address, e.g. &quot;Foo Bar&quot; &lt;isso@example.tld&gt;</span>
<span class="na">from</span> <span class="o">=</span>

<span class="c1"># specify a timeout in seconds for blocking operations like the</span>
<span class="c1"># connection attempt.</span>
<span class="na">timeout</span> <span class="o">=</span> <span class="s">10</span>


<span class="k">[guard]</span>
<span class="c1"># 反垃圾机制</span>
<span class="c1"># Enable basic spam protection features, e.g. rate-limit per IP address (/24</span>
<span class="c1"># for IPv4, /48 for IPv6).</span>

<span class="c1"># enable guard, recommended in production. Not useful for debugging purposes.</span>
<span class="na">enabled</span> <span class="o">=</span> <span class="s">true</span>

<span class="c1"># limit to N new comments per minute.</span>
<span class="na">ratelimit</span> <span class="o">=</span> <span class="s">2</span>

<span class="c1"># how many comments directly to the thread (prevent a simple while true; do</span>
<span class="c1"># curl ...; done.</span>
<span class="na">direct-reply</span> <span class="o">=</span> <span class="s">3</span>

<span class="c1"># allow commenters to reply to their own comments when they could still edit</span>
<span class="c1"># the comment. After the editing timeframe is gone, commenters can reply to</span>
<span class="c1"># their own comments anyways. Do not forget to configure the client.</span>
<span class="na">reply-to-self</span> <span class="o">=</span> <span class="s">true</span>

<span class="c1"># force commenters to enter a value into the author field. No validation is</span>
<span class="c1"># performed on the provided value.  Do not forget to configure the client</span>
<span class="c1"># accordingly.</span>
<span class="na">require-author</span> <span class="o">=</span> <span class="s">true</span>

<span class="c1"># require the commenter to enter an email address (note: no validation is</span>
<span class="c1"># done on the provided address). Do not forget to configure the client.</span>
<span class="na">require-email</span> <span class="o">=</span> <span class="s">true</span>


<span class="k">[markup]</span>
<span class="c1"># 评论内容机制</span>
<span class="c1"># Customize markup and sanitized HTML. Currently, only Markdown (via Misaka) is</span>
<span class="c1"># supported, but new languages are relatively easy to add.</span>

<span class="c1"># Misaka-specific Markdown extensions, all flags starting with EXT_ can be used</span>
<span class="c1"># there, separated by comma.</span>
<span class="na">options</span> <span class="o">=</span> <span class="s">strikethrough, autolink, fenced_code, no_intra_emphasis</span>

<span class="c1"># Additional HTML tags to allow in the generated output, comma-separated. By</span>
<span class="c1"># default, only a, blockquote, br, code, del, em, h1, h2, h3, h4, h5, h6, hr,</span>
<span class="c1"># ins, li, ol, p, pre, strong, table, tbody, td, th, thead and ul are allowed.</span>
<span class="na">allowed-elements</span> <span class="o">=</span>

<span class="c1"># Additional HTML attributes (independent from elements) to allow in the</span>
<span class="c1"># generated output, comma-separated. By default, only align and href are</span>
<span class="c1"># allowed.</span>
<span class="na">allowed-attributes</span> <span class="o">=</span>


<span class="k">[hash]</span>
<span class="c1"># 安全相关</span>
<span class="c1"># Customize used hash functions to hide the actual email addresses from</span>
<span class="c1"># commenters but still be able to generate an identicon.</span>


<span class="c1"># A salt is used to protect against rainbow tables. Isso does not make use of</span>
<span class="c1"># pepper (yet). The default value has been in use since the release of Isso and</span>
<span class="c1"># generates the same identicons for same addresses across installations.</span>
<span class="na">salt</span> <span class="o">=</span> <span class="s">Eech7co8Ohloopo9Ol6baimi</span>

<span class="c1"># Hash algorithm to use -- either from Python&#39;s hashlib or PBKDF2 (a</span>
<span class="c1"># computational expensive hash function).</span>
<span class="c1">#</span>
<span class="c1"># The actual identifier for PBKDF2 is pbkdf2:1000:6:sha1, which means 1000</span>
<span class="c1"># iterations, 6 bytes to generate and SHA1 as pseudo-random family used for key</span>
<span class="c1"># strengthening. Arguments have to be in that order, but can be reduced to</span>
<span class="c1"># pbkdf2:4096 for example to override the iterations only.</span>
</pre></div>


<h4>修改模板</h4>
<p>配置完服务端，客户段(JS)需要相应修改，由于我使用的是Pelican静态博客生成工具，在主题文件夹新增了一个isso.html模板。</p>
<p><strong><em>isso.html</em></strong></p>
<div class="highlight"><pre><span></span>{% if ISSO_RUNNING %}

<span class="p">&lt;</span><span class="nt">section</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;isso-thread&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">section</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">data-isso</span><span class="o">=</span><span class="s">&quot;//comment.kukumalu.cc/&quot;</span>  
    <span class="na">data-isso-css</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
    <span class="na">data-isso-lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span>
    <span class="na">data-isso-reply-to-self</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
    <span class="na">data-isso-require-author</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
    <span class="na">data-isso-require-email</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
    <span class="na">data-isso-max-comments-top</span><span class="o">=</span><span class="s">&quot;10&quot;</span>
    <span class="na">data-isso-max-comments-nested</span><span class="o">=</span><span class="s">&quot;5&quot;</span>
    <span class="na">data-isso-reveal-on-click</span><span class="o">=</span><span class="s">&quot;5&quot;</span>
    <span class="na">data-isso-avatar</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
    <span class="na">data-isso-avatar-bg</span><span class="o">=</span><span class="s">&quot;#f0f0f0&quot;</span>
    <span class="na">data-isso-avatar-fg</span><span class="o">=</span><span class="s">&quot;#9abf88 #5698c4 #e279a3 #9163b6 ...&quot;</span>
    <span class="na">data-isso-vote</span><span class="o">=</span><span class="s">&quot;true&quot;</span>
    <span class="na">data-vote-levels</span><span class="o">=</span><span class="s">&quot;[-5,5,15]&quot;</span>
    <span class="na">src</span><span class="o">=</span><span class="s">&quot;//comment.kukumalu.cc/js/embed.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>

{% endif %}
</pre></div>


<p>Isso 通常会自动检测 REST API, 但如果 JS 文件(Isso的JS实例)并不在默认位置则需要修改 <code>data-isso</code>属性来覆写，值得注意的是<code>src</code>中URI写法并未包含http头。</p>
<p>JS端配置成功后，可以在网页中看到整个评论的form，在<a href="http://comment.kukumalu.cc/info">http://comment.kukumalu.cc/info</a>也能查到关于Isso的信息。</p>
<h4>Nginx 配置</h4>
<p>先提供一些CORS Nginx配置的参考内容</p>
<ul>
<li><a href="https://enable-cors.org/server_nginx.html">https://enable-cors.org/server_nginx.html</a></li>
<li><a href="https://michielkalkman.com/snippets/nginx-cors-open-configuration/">https://michielkalkman.com/snippets/nginx-cors-open-configuration/</a></li>
<li><a href="http://m.blog.csdn.net/oyzl68/article/details/18741057">http://m.blog.csdn.net/oyzl68/article/details/18741057</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS</a></li>
<li><a href="http://xiaorui.cc/2016/03/07/在nginx配置cors请求的headers头部信息/">http://xiaorui.cc/2016/03/07/在nginx配置cors请求的headers头部信息/</a></li>
</ul>
<p>CORS在Isso包文档中谈及的不多，但我仅使用文档中的模板配置没用办法成功运行(500错误，CORS头部丢失)。nohup.out的错误信息如下:</p>
<div class="highlight"><pre><span></span>127.0.0.1 - - [2017-10-22 15:04:10] &quot;OPTIONS /count HTTP/1.0&quot; 500 161 0.000654
Traceback (most recent call last):
  File &quot;/home/app/negativedearc.github.io/venv/local/lib/python2.7/site-packages/gevent/pywsgi.py&quot;, line 935, in handle_one_response
    self.run_application()
  File &quot;/home/app/negativedearc.github.io/venv/local/lib/python2.7/site-packages/gevent/pywsgi.py&quot;, line 908, in run_application
    self.result = self.application(self.environ, self.start_response)
  File &quot;/home/app/negativedearc.github.io/venv/local/lib/python2.7/site-packages/werkzeug/contrib/fixers.py&quot;, line 152, in __call__
    return self.app(environ, start_response)
  File &quot;/home/app/negativedearc.github.io/venv/local/lib/python2.7/site-packages/isso/wsgi.py&quot;, line 119, in __call__
    return self.app(environ, start_response)
  File &quot;/home/app/negativedearc.github.io/venv/local/lib/python2.7/site-packages/isso/wsgi.py&quot;, line 147, in __call__
    add_cors_headers(&quot;200 Ok&quot;, [(&quot;Content-Type&quot;, &quot;text/plain&quot;)])
  File &quot;/home/app/negativedearc.github.io/venv/local/lib/python2.7/site-packages/isso/wsgi.py&quot;, line 144, in add_cors_headers
    return start_response(status, headers.to_list(), exc_info)
  File &quot;/home/app/negativedearc.github.io/venv/local/lib/python2.7/site-packages/gevent/pywsgi.py&quot;, line 830, in start_response
    raise UnicodeError(&quot;The status string must be a native string&quot;)
UnicodeError: The status string must be a native string
Sun Oct 22 15:04:10 2017 {&#39;REMOTE_PORT&#39;: &#39;52242&#39;, &#39;HTTP_HOST&#39;: &#39;comment.kukumalu.cc&#39;, &#39;REMOTE_ADDR&#39;: &#39;114.216.124.225&#39;, (hidden keys: 30)} failed with UnicodeError
</pre></div>


<p>Isso在其<a href="https://github.com/posativ/isso/blob/master/isso/wsgi.py#L122">wsgi.py</a>中已经提前处理了CORS需要的头部信息。</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CORSMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add Cross-origin resource sharing headers to every request.&quot;&quot;&quot;</span>

    <span class="n">methods</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">allowed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">exposed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">origin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed</span> <span class="o">=</span> <span class="n">allowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exposed</span> <span class="o">=</span> <span class="n">exposed</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">add_cors_headers</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">(</span><span class="n">environ</span><span class="p">))</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Credentials&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">)</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Methods&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">methods</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Access-Control-Allow-Headers&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exposed</span><span class="p">:</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;Access-Control-Expose-Headers&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exposed</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span> <span class="n">exc_info</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;REQUEST_METHOD&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span>
            <span class="n">add_cors_headers</span><span class="p">(</span><span class="s2">&quot;200 Ok&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span> <span class="s2">&quot;text/plain&quot;</span><span class="p">)])</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">add_cors_headers</span><span class="p">)</span>
</pre></div>


<p>但似乎OPTIONS没有处理成功？推测原因：</p>
<ul>
<li>Nginx 没有(无法)正确处理OPTIONS请求，<a href="https://stackoverflow.com/questions/14929347/how-to-handle-options-request-in-nginx">参考资料</a></li>
<li>wsgi MiddleWare 没有正确假如头部信息（需要确认，<a href="https://github.com/posativ/isso/issues/347">参考资料</a>）。</li>
</ul>
<p>无论如何，在改动Nginx配置（手动加入OPTIONS判断）后运行成功了。</p>
<p><strong><em>isso.conf</em></strong></p>
<div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span>         <span class="mi">80</span><span class="p">;</span>
    <span class="kn">server_name</span>    <span class="s">comment.kukumalu.cc</span><span class="p">;</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:8080</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>


        <span class="kn">if</span> <span class="s">(</span><span class="nv">$request_method</span> <span class="p">=</span> <span class="s">&#39;OPTIONS&#39;)</span> <span class="p">{</span>
            <span class="kn">add_header</span> <span class="s">&#39;Access-Control-Allow-Origin&#39;</span> <span class="s">&#39;http://www.kukumalu.cc&#39;</span><span class="p">;</span>
            <span class="kn">add_header</span> <span class="s">&#39;Access-Control-Allow-Methods&#39;</span> <span class="s">&#39;HEAD,</span> <span class="s">GET,</span> <span class="s">POST,</span> <span class="s">PUT,</span> <span class="s">DELETE&#39;</span><span class="p">;</span>
            <span class="kn">add_header</span> <span class="s">&#39;Access-Control-Allow-Credentials&#39;</span> <span class="s">&#39;true&#39;</span><span class="p">;</span>
            <span class="kn">add_header</span> <span class="s">&#39;Access-Control-Allow-Headers&#39;</span> <span class="s">&#39;Origin,</span> <span class="s">Referer,</span> <span class="s">Content-Type&#39;</span><span class="p">;</span>

            <span class="c1"># Tell client that this pre-flight info is valid for 20 days</span>

            <span class="kn">add_header</span> <span class="s">&#39;Access-Control-Max-Age&#39;</span> <span class="mi">1728000</span><span class="p">;</span>
            <span class="kn">add_header</span> <span class="s">&#39;Content-Type&#39;</span> <span class="s">&#39;text/plain</span><span class="p">;</span> <span class="kn">charset=utf-8&#39;</span><span class="p">;</span>
            <span class="kn">add_header</span> <span class="s">&#39;Content-Length&#39;</span> <span class="mi">0</span><span class="p">;</span>
            <span class="kn">return</span> <span class="mi">204</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>放入vhost中与其它Nginx服务一起运行。</p>
<h4>运行</h4>
<p>生产环境下，运行isso最简单的方式是使用<code>gevent</code>，两个步骤就可以搞定。</p>
<div class="highlight"><pre><span></span>pip install gevent -i https://pypi.douban.com/simple
isso -c isso.cfg run
</pre></div>


<p>至此，isso可以完美的运行起来。</p>
<h3>其他</h3>
<ul>
<li>评论后台管理，目前pip版本暂无此功能提供，只能手动操作评论数据库，但全能的网友PR了作者<a href="https://github.com/posativ/isso/pull/256">https://github.com/posativ/isso/pull/256</a>，由于作者非常忙，还没有Merge。</li>
<li>感谢<a href="https://www.pupboss.com/build-a-comment-system-using-isso/">https://www.pupboss.com/build-a-comment-system-using-isso/</a>，可能是互联网找得到唯一一篇部署isso的博客。 </li>
<li>github issue非常有用，项目的知识库对整个project的leverage具有非常大的推进、参考、风险避免的作用。</li>
</ul></div>
	<hr>
	<h2>Comments</h2>
</div>
		</div>
	</div> 	<!-- <hr> -->
</div> <!-- /container -->
<footer class="aw-footer bg-danger">
	<div class="container"> <!-- footer -->
		<div class="row">
			<div class="col-md-10 col-md-offset-1">
				<div class="row">
					<div class="col-md-3">
						<h4>Archive</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="https://negativedearc.github.io/archives.html">存档</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Author</h4>
						<ul class="list-unstyled my-list-style">
						<li><a href="https://negativedearc.github.io/feeds/all.atom.xml" type="application/atom+xml"><i class="fa fa-rss "></i> atom</a></li>

							<li><a href="mailto:datingwithme@live.cn">E-Mail</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Categories</h4>
						<ul class="list-unstyled my-list-style">
							<!-- <li><a href="https://negativedearc.github.io/category/编程.html">编程 (7)</a></li> -->
							<!-- fix the bug that chinese name categories can not be parse to url -->
							<li><a href="https://negativedearc.github.io/category/bian-cheng.html">编程 (7)</a></li>
							<!-- <li><a href="https://negativedearc.github.io/category/工作.html">工作 (10)</a></li> -->
							<!-- fix the bug that chinese name categories can not be parse to url -->
							<li><a href="https://negativedearc.github.io/category/gong-zuo.html">工作 (10)</a></li>
							<!-- <li><a href="https://negativedearc.github.io/category/情感.html">情感 (1)</a></li> -->
							<!-- fix the bug that chinese name categories can not be parse to url -->
							<li><a href="https://negativedearc.github.io/category/qing-gan.html">情感 (1)</a></li>
							<!-- <li><a href="https://negativedearc.github.io/category/数据分析.html">数据分析 (1)</a></li> -->
							<!-- fix the bug that chinese name categories can not be parse to url -->
							<li><a href="https://negativedearc.github.io/category/shu-ju-fen-xi.html">数据分析 (1)</a></li>
						</ul>
					</div>
					<div class="col-md-3">
						<h4>Links</h4>
						<ul class="list-unstyled my-list-style">
							<li><a href="http://www.cxwloves.cc/">香阁公主</a></li>
							<li><a href="http://www.kukumalu.cc">酷酷马鹿</a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</footer>
<div class="container">
	<div class="row">
		<div class="col-md-12 text-center center-block aw-bottom">
			<p>&copy; NegativeDearc 2016-2020</p>
			<p>Powered by <a href="https://github.com/getpelican/pelican">Pelican</a>, Themed by <a href="https://github.com/getpelican/pelican-themes/tree/master/aboutwilson">aboutwilson</a></p>
			<p><a href="http://beian.miit.gov.cn">苏ICP备:17001932-2</a></p>
		</div>
	</div>
</div>
<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script type="text/javascript">
jQuery(document).ready(function($) {
	$("div.collapseheader").click(function () {
		$header = $(this).children("span").first();
		$codearea = $(this).children(".input_area");
		$codearea.slideToggle(500, function () {
			$header.text(function () {
				return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
			});
		});
	});
});
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-56532006-2', 'auto');
  ga('send', 'pageview');

</script>
</body>
</html>